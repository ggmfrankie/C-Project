//
// Created by Stefan on 05.12.2025.
//

#include "MonteCarlo.h"

#include <bemapiset.h>
#include <stdbool.h>
#include <math.h>
#include <time.h>

#include "libminibmp.h"
#include "../../Utils/Makros.h"
#include "../../Utils/Vector.h"


void drawPolygon(Vec2i polygon[], size_t length);
void drawRectangle(const bmp *image, Vec2i c1, Vec2i c2);

Vec2i getRectangleDimensions(const Vec2i *polygon, size_t length);
bool isInsidePolygon(const Vec2i* polygon, size_t length, Vec2i corners, Vec2i point);
void drawRandomPoints(const bmp *image, const Vec2i* polygon, Vec2i dimensions , size_t length, int numOfPoints);

void drawPolygon(Vec2i polygon[], const size_t length) {

    const Vec2i corners = getRectangleDimensions(polygon, length);
    const bmp bitmap = newBMP(1600, 900);

    for (int i = 0; i < length; i++) {
        const Vec2i pointA = polygon[i];
        const Vec2i pointB = polygon[(i+1)%length];

        drawLine(&bitmap, pointA, pointB, COL_black);
    }
    drawRectangle(&bitmap, (Vec2i){0, 0}, (Vec2i){corners.x, corners.y});
    drawRandomPoints(&bitmap, polygon, corners, length, 300000);
    save_BMP("Polygon.bmp",&bitmap);
}

void drawRectangle(const bmp *image, const Vec2i c1, const Vec2i c2) {
    drawLine(image, c1, (Vec2i){c2.x, c1.y}, COL_green);
    drawLine(image, c1, (Vec2i){c1.x, c2.y}, COL_green);
    drawLine(image, c2, (Vec2i){c2.x, c1.y}, COL_green);
    drawLine(image, c2, (Vec2i){c1.x, c2.y}, COL_green);
}

void drawRandomPoints(const bmp *image, const Vec2i* polygon, const Vec2i dimensions ,const size_t length, const int numOfPoints) {
    srand(time(NULL));
    int pointsInside = 0;
    for (int i = 0; i < numOfPoints; i++) {
        Vec2i point = {(rand()%dimensions.x), (rand()%dimensions.y)};
        pixelcolor pixCol;
        if (isInsidePolygon(polygon, length, dimensions, point)) {
            pixCol = COL_green;
            pointsInside++;
        } else {
            pixCol = COL_red;
        }
        setPixel(image, point.x, point.y, pixCol);
    }
    int pointsOutside = numOfPoints-pointsInside;
    printf("Zi: \t%i\n", pointsInside);
    printf("Za: \t%i\n", pointsOutside);
    printf("VerhÃ¤ltnis: \t%f\n", (float) pointsInside/pointsOutside);
    puts("--------------------------------");
    printf("Rechteck: \t%i Quadratpixel\n", dimensions.x*dimensions.y);
    printf("Polygon: \t%i Quadratpixel\n", (int)((dimensions.x*dimensions.y)*(float)pointsInside/numOfPoints));
}

Vec2i getRectangleDimensions(const Vec2i polygon[], const size_t length) {
    Vec2i corners = {};
    for (int i = 0; i < length; i ++) {
        const Vec2i point = polygon[i];
        corners.x = max(corners.x, point.x);
        corners.y = max(corners.y, point.y);
    }
    return corners;
}

bool isInsidePolygon(const Vec2i* polygon, const size_t length, const Vec2i corners, const Vec2i point) {

    int intersections = 0;

    for (int i = 0; i < length; i++) {
        const Vec2i pointA = polygon[i];
        const Vec2i pointB = polygon[(i+1)%length];

        //is point behind the segment?
        if (point.x > pointA.x && point.x > pointB.x) continue;

        //is point below or above the segment?
        if (point.y > pointA.y && point.y > pointB.y) continue;
        if (point.y < pointA.y && point.y < pointB.y) continue;

        const int cross = Vec2i_Cross(v_sub(point, pointA), v_sub(pointB,pointA));

        //deduplicate
        if (pointA.y >= pointB.y) {
            if (point.y == pointA.y || cross < 0) continue;
            intersections++;
        } else {
            if (point.y == pointB.y || cross > 0) continue;
            intersections++;
        }
    }
    return intersections % 2;
}

void monteCarlo() {
    Vec2i polygon[] ={
{630, 725}, {769, 697}, {595, 764}, {571, 744}, {564, 743}, {494, 749}, {379, 725}, {349, 682},
{317, 679}, {366, 748}, {322, 775}, {341, 781}, {351, 767}, {464, 773}, {485, 780}, {549, 754},
{514, 784}, {446, 820}, {540, 803}, {680, 752}, {647, 771}, {603, 789}, {606, 816}, {649, 839},
{773, 822}, {787, 843}, {848, 822}, {902, 801}, {1013, 730}, {1204, 833}, {1289, 784}, {1215, 767},
{1131, 737}, {1006, 724}, {1118, 665}, {1177, 666}, {1057, 700}, {1156, 711}, {1367, 727}, {1330, 715},
{1326, 675}, {1322, 696}, {1287, 644}, {1346, 673}, {1348, 671}, {1322, 624}, {1290, 559}, {1228, 563},
{1300, 545}, {1265, 543}, {1158, 514}, {1109, 522}, {1211, 584}, {1141, 601}, {1182, 593}, {918, 727},
{787, 759}, {631, 793}, {838, 729}, {869, 709}, {1003, 655}, {1042, 615}, {948, 656}, {741, 728},
{819, 686}, {969, 642}, {1037, 606}, {1091, 586}, {1114, 548}, {1074, 553}, {940, 610}, {965, 545},
{900, 539}, {864, 493}, {794, 505}, {866, 454}, {849, 453}, {732, 497}, {637, 389}, {618, 429},
{627, 520}, {531, 514}, {454, 476}, {440, 449}, {375, 463}, {282, 412}, {241, 339}, {257, 329},
{174, 206}, {171, 275}, {135, 256}, {180, 169}, {217, 175}, {304, 180}, {221, 139}, {209, 147},
{215, 148}, {102, 146}, {98, 131}, {80, 113}, {205, 38}, {165, 94}, {290, 122}, {259, 123},
{381, 121}, {392, 237}, {361, 229}, {264, 210}, {254, 247}, {311, 241}, {453, 253}, {567, 267},
{562, 268}, {428, 303}, {478, 316}, {446, 363}, {417, 295}, {342, 281}, {259, 254}, {362, 332},
{367, 381}, {293, 382}, {342, 405}, {337, 407}, {342, 425}, {399, 401}, {417, 432}, {468, 444},
{440, 437}, {552, 429}, {506, 413}, {462, 405}, {552, 329}, {618, 342}, {605, 261}, {717, 277},
{617, 235}, {499, 245}, {578, 226}, {474, 151}, {437, 193}, {401, 106}, {300, 120}, {419, 76},
{480, 36}, {502, 47}, {570, 42}, {616, 84}, {600, 25}, {782, 59}, {896, 103}, {887, 109},
{837, 123}, {861, 152}, {837, 130}, {735, 117}, {644, 55}, {742, 132}, {831, 158}, {711, 162},
{568, 103}, {530, 75}, {450, 61}, {468, 80}, {374, 99}, {584, 118}, {623, 133}, {542, 179},
{650, 225}, {754, 190}, {737, 307}, {724, 344}, {717, 361}, {714, 368}, {752, 417}, {727, 414},
{854, 436}, {801, 344}, {825, 313}, {836, 315}, {984, 432}, {893, 442}, {1159, 507}, {1057, 410},
{1065, 442}, {906, 355}, {906, 302}, {819, 303}, {744, 324}, {767, 276}, {768, 259}, {885, 226},
{825, 201}, {830, 225}, {781, 248}, {779, 171}, {899, 163}, {824, 172}, {867, 186}, {968, 187},
{1055, 92}, {1073, 83}, {965, 100}, {933, 96}, {944, 65}, {1044, 52}, {1251, 31}, {1299, 25},
{1513, 34}, {1209, 53}, {1122, 100}, {1156, 108}, {1224, 75}, {1271, 52}, {1176, 159}, {1084, 174},
{1009, 247}, {1095, 227}, {1106, 261}, {1060, 292}, {1083, 326}, {1201, 266}, {1083, 326}, {1045, 320},
{964, 216}, {905, 217}, {995, 370}, {1090, 325}, {1025, 366}, {1057, 375}, {1099, 408}, {1140, 420},
{1154, 320}, {1222, 302}, {1272, 338}, {1163, 339}, {1163, 368}, {1186, 415}, {1249, 443}, {1125, 441},
{1221, 527}, {1215, 516}, {1223, 500}, {1252, 470}, {1321, 460}, {1345, 484}, {1342, 544}, {1388, 513},
{1396, 617}, {1393, 600}, {1350, 670}, {1406, 719}, {1516, 711}, {1405, 695}, {1444, 640}, {1452, 581},
{1472, 576}, {1415, 479}, {1405, 534}, {1390, 428}, {1340, 452}, {1401, 389}, {1359, 421}, {1333, 416},
{1350, 407}, {1364, 401}, {1353, 399}, {1367, 384}, {1364, 355}, {1378, 352}, {1371, 342}, {1237, 287},
{1354, 187}, {1253, 223}, {1216, 247}, {1218, 166}, {1294, 126}, {1278, 66}, {1380, 93}, {1317, 144},
{1340, 131}, {1396, 164}, {1420, 151}, {1411, 86}, {1333, 61}, {1482, 86}, {1466, 55}, {1565, 73},
{1565, 282}, {1574, 304}, {1568, 330}, {1545, 286}, {1498, 228}, {1464, 206}, {1512, 172}, {1484, 169},
{1456, 169}, {1389, 192}, {1326, 265}, {1411, 326}, {1476, 359}, {1427, 307}, {1457, 319}, {1500, 330},
{1550, 378}, {1570, 472}, {1518, 405}, {1506, 413}, {1462, 444}, {1478, 434}, {1512, 457}, {1509, 442},
{1554, 489}, {1524, 624}, {1487, 523}, {1490, 601}, {1479, 647}, {1539, 735}, {1448, 730}, {1362, 718},
{1378, 730}, {1557, 748}, {1548, 673}, {1547, 627}, {1572, 473}, {1574, 466}, {1574, 678}, {1566, 827},
{1534, 836}, {1493, 856}, {1570, 842}, {1541, 872}, {1391, 861}, {1159, 842}, {1132, 842}, {1009, 815},
{848, 836}, {946, 873}, {756, 864}, {290, 875}, {399, 851}, {503, 847}, {395, 838}, {470, 840},
{548, 849}, {632, 839}, {536, 820}, {375, 820}, {235, 803}, {216, 822}, {170, 832}, {193, 820},
{74, 867}, {47, 872}, {51, 846}, {60, 813}, {61, 791}, {55, 787}, {49, 834}, {25, 637},
{88, 608}, {54, 489}, {37, 424}, {43, 373}, {25, 306}, {37, 138}, {136, 249}, {111, 338},
{87, 397}, {82, 410}, {63, 336}, {42, 368}, {58, 401}, {44, 410}, {39, 423}, {73, 436},
{78, 420}, {104, 466}, {104, 562}, {113, 485}, {218, 581}, {295, 581}, {307, 587}, {277, 548},
{231, 537}, {225, 520}, {243, 511}, {256, 466}, {230, 481}, {196, 422}, {162, 372}, {173, 329},
{142, 267}, {257, 416}, {279, 417}, {286, 436}, {295, 454}, {383, 504}, {339, 513}, {373, 559},
{418, 526}, {513, 566}, {522, 571}, {518, 582}, {558, 568}, {575, 575}, {628, 548}, {663, 543},
{667, 544}, {775, 510}, {748, 540}, {544, 607}, {481, 597}, {387, 582}, {503, 620}, {569, 605},
{557, 626}, {703, 639}, {881, 603}, {796, 686}, {748, 673}, {716, 674}, {557, 698}, {490, 695},
{479, 643}, {424, 640}, {275, 618}, {157, 722}, {193, 589}, {135, 653}, {146, 593}, {144, 580},
{139, 580}, {127, 569}, {100, 602}, {136, 647}, {76, 822}, {98, 855}, {171, 817}, {125, 805},
{200, 761}, {210, 707}, {250, 651}, {290, 621}, {323, 655}, {364, 633}, {373, 634}, {515, 719},
{612, 691}, {633, 710},
};

    drawPolygon(polygon, sizeof(polygon) / sizeof(Vec2i));

}